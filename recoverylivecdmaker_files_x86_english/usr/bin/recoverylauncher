#! /bin/bash
#This file is part of LinuxRCD.
#
#    LinuxRCD is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    LinuxRCD is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with LinuxRCD.  If not, see <http://www.gnu.org/licenses/>.
#
#This file was last modified 08/04/002010 (Gregorian Calendar) 11:34 UTC

#TODO remove part that says wont work
 kdialog --msgbox  "Welcome to the Ubuntu Recovery CD from http://ubuntuforums.org/showthread.php?t=1254973 


Press OK to continue."



kdialog --msgbox "This Live CD is used to recover broken Ubuntu systems (and POSSIBLY other distros). This CD is not offical from Ubuntu, but it should work. This is not meant to be a DATA recovery CD, to recover accedently deleted files. If you wanted a DATA recovery CD, use Photorec, and do not write anything to the filesystem that you deleted the files from, because the more you write to a filesystem the less chance that data recovery is possible. This is for recovering Ubuntu systems that are unusable instead.

This will not see Wubi installs yet, and wont see encrypted ones. It will not be able to recover systems of incomptible architechture, such as 32 bit CD recovering a 64 bit system. (a 64 bit disk MIGHT be able to recover a 32 bit system however. it has not been tested yet) 


The CPU architechture of this cd is 32 bit, x86. 

Press OK to contine.
"

kdialog --msgbox "Be aware that as soon as you mount into your system, it is not like other Live CDs where all modifications go away after reboot. In this Live CD, everything runs as root, except for the web browser that automaticaly starts upon boot. If you create a second window of the web browser from the panel below, it will run as root, (and is not the best idea to do so.) The non root browser, if accedentaly closed will automatialy restart as non-root. The Xephyr program also reopen if closed as root as they are root to begin with. 

Press OK to contine"


kdialog --msgbox "Lets begin. As you can see, upon startup, there is window called \"Xephyr\"  The Xephyr window will contain a GUI running as the system that you selected. Do not be alarmed that the GUI is different (as in not your standard desktop environment, whether its Gnome or KDE, or whatever you use). This Live CD uses LXDE within the Xephyr Window. Whatever you do within the Xephyr window will affect the system you seleted to mount (such as using Synaptic within the Xephyr window to install a package). 

The web browser is the only thing not running as root (so do not open a new one from the panel), and is there so you can search for solution on the web if you need help fixing your system.

These sets of dialogs walk you through mounting your system, and making it usable for you in the Xephyr window.

Press OK to continue."




kdialog --msgbox "OK. Now you can choose which Linux install you want to control. They will be listed below, but give the list some time to build. You can select your OS by entering the preceding number, then hitting enter. Please be patient as it may take a while for all operating systems to be found.


If it seems like you OS is not listed here, please report to http://ubuntuforums.org/showthread.php?t=1254973, as you might be using a weird filesystem, or something may be wrong where the FS type can not be detected. If you manage to mount your target automatially at /media/RecoveryMount after it failing to detect your OS, when you get back to this screen, select the blank entry, and it will use the file system already mounted.
"
#list all detected installed into a file
os-prober > /usr/share/detectedoses
echo " " >>     /usr/share/detectedoses
#list the contents of the file for the user 
#cat /usr/share/detectedoses | awk '{print FNR "   "  $0 }'
#capture number of oses
oscount=$(cat /usr/share/detectedoses | grep : -c)
#if no oses detected then die
if (( 0==oscount ));
then
kdialog --msgbox " No OSes found. This process will now quit. If you do have OSes installed, it must be on an strange filesystem, corrupt filesystem, or a more serious problem might exist."
exit 0
fi
oschoice=$(kdialog --combobox " Choose your OS: " $(cat /usr/share/detectedoses | sed s/" "/"_"/g ))
 
#run os prober again, and grab the entire OS line
echo $oschoice > /usr/share/osline
#get the device file name where the OS is installed
cat /usr/share/osline | sed  's/:.*/ /' > /usr/share/devname
#make the mountpoint where the system will be mounted
mkdir /media/RecoveryMount
#mount the system with the device name as readonly
mount $(cat /usr/share/devname) /media/RecoveryMount -o ro
#test chroot,
chroot /media/RecoveryMount  /bin/true
#if it failed 
if [[ $? -ne 0 ]]
then
#tell the user something went wrong
kdialog --msgbox "Unable to access your selected system. Either the physical mounting of the filesystem failed, you selected an invalad choice, or you have some critical files missing in your system (the file thats missing is /bin/true).

The choice you selected was: $(cat /usr/share/osline)"

umount /media/RecoveryMount
kdialog --msgbox "This process will start over, allowing you to select a different OS."
exit 1
fi


kdialog --yesno "Do you want to perform a disk check on your file system before you continue?"
checkdisk=$?


if [[ $checkdisk -eq 0 ]]
then
#unmount the read only file system
umount /media/RecoveryMount
#check the specified root file system for errors
kdialog --msgbox "Disk check has been started. Check the recoverylauncer terminal window below for progress. When the disk check is finished, your system will be mounted." &
fsck -p $(cat /usr/share/devname)
fi

#unmount the read only file system
umount /media/RecoveryMount


#mount the system with the device name
mount $(cat /usr/share/devname) /media/RecoveryMount

#mount in the devfs into the mountpoint
mount --bind /dev /media/RecoveryMount/dev

#mount in dbus so apps work
mount --bind /var/run/dbus /media/RecoveryMount/var/run/dbus

#mount in X11 authorization folder. 
mount --bind /tmp/.X11-unix /media/RecoveryMount/tmp/.X11-unix

#make the opt/recoverystuff folder in case if its not there
mkdir /media/RecoveryMount/opt/recoverystuff

#bind the live cds /usr folder to the targets /opt folder
mount --rbind /usr /media/RecoveryMount/opt/recoverystuff

#xhost needs this as it does not accept a display argument
export DISPLAY=:1

#allow all local connections
xhost +local:

#change the hostname of the live cd session to that of the selected target system
hostname -F /media/RecoveryMount/etc/hostname

#start the chroot script. Run it as a background task so that this can prompt for done
chroot /media/RecoveryMount  /opt/recoverystuff/bin/recoverychrootscript &


############################################################

export DISPLAY=:0

kdialog --msgbox "The live cd is now in recovery mode. You should be able to control your system within Xephyr now. Do not turn off your computer untill you are done. 

Note that if you use a seperate partition for your home folder, or filesystems that automatically mount when you boot, it tried to mount them, but they could have failed if the file system config file was broken."

kdialog --msgbox "When you are done recovering your system press OK in this dialog to quit. "


kdialog --yesno "Are you sure you want to exit out of your system?"
quitanswer=$?
while [  $quitanswer != 0   ] ; do  kdialog --yesno "Are you sure you want to exit out of your system?"; quitanswer=$? ; done 

#kill all X apps by destroying the display. Many apps perform a safe exit routine when the X server dies
killall Xephyr

#gently kill any other processess
fuser -15 -k /media/RecoveryMount

# TODO this might need to wait, but the command might do that for us

#forcibly kill the processess
fuser -k /media/RecoveryMount

#change the hostname of the live cd back to the default
hostname -F /etc/hostname

#unlink the symlink created
unlink /media/RecoveryMount/FileSystems

#unmount recovery systems /sys
umount -lf /media/RecoveryMount/sys

#unmount recovery systems /proc
umount -lf /media/RecoveryMount/proc

#unmount recovery systems /dev/pts
umount -lf /media/RecoveryMount/dev/pts

#unmount recovery systems /dev
umount -lf /media/RecoveryMount/dev

#unmount the dbus folder
umount /media/RecoveryMount/var/run/dbus

#unmount the X11 authroization folder
umount /media/RecoveryMount/tmp/.X11-unix

#unmount the /usr folder
umount /media/RecoveryMount/opt/recoverystuff

#unmount all fstab partitions
chroot /media/RecoveryMount umount -a

#unmount the recovered systems fs
umount -lf /media/RecoveryMount

kdialog --msgbox " Your have exited out of your target system. Press OK to close this dialog, and to open the welcome dialog again. Your system will not be remounted, but it will allow you to remount it again, or select another one of your installed oses"
exit 0 
